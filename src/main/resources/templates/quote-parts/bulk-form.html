<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(~{::title}, ~{::.content}, ~{::style}, ~{::script})}"
      th:with="activePage='quoteParts'">
<head>
    <title>Í≤¨Ï†Å Î∂ÄÌíà ÎåÄÎüâ Îì±Î°ù - MURATEC</title>
    <style>
        .excel-table {
            width: 100%;
            overflow-x: auto;
        }
        .excel-table table {
            width: 100%;
            table-layout: fixed;
        }
        .excel-table input {
            width: 100%;
            font-size: 0.7rem;
            padding: 2px 4px;
            border: 1px solid #ccc;
        }
        .excel-table th {
            background-color: #2c3e50;
            color: white;
            font-weight: bold;
            padding: 4px 2px;
            font-size: 0.65rem;
            white-space: normal;
            word-wrap: break-word;
            position: sticky;
            top: 0;
            z-index: 10;
            line-height: 1.2;
        }
        .excel-table td {
            padding: 1px;
            border: 1px solid #ddd;
        }
        .row-number {
            background-color: #ecf0f1;
            font-weight: bold;
            text-align: center;
            width: 30px;
            max-width: 30px;
            padding: 2px !important;
        }
        .btn-container {
            position: sticky;
            top: 0;
            background: white;
            z-index: 100;
            padding: 10px 0;
            margin-bottom: 10px;
            border-bottom: 2px solid #ddd;
        }
        .table-container {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        .row-number { width: 3% !important; }
        .col-short { width: 6%; }
        .col-medium { width: 7.5%; }
        .col-long { width: 9.5%; }
    </style>
</head>
<body>
    <div class="content">
        <div class="btn-container">
            <h2>Í≤¨Ï†Å Î∂ÄÌíà ÎåÄÎüâ Îì±Î°ù</h2>
            <div class="d-flex gap-2 mt-2">
                <button class="btn btn-success" onclick="addRow()">+ Ìñâ Ï∂îÍ∞Ä</button>
                <button class="btn btn-danger" onclick="removeLastRow()">- ÎßàÏßÄÎßâ Ìñâ ÏÇ≠Ï†ú</button>
                <button class="btn btn-primary" onclick="saveAll()">Ï†ÑÏ≤¥ Ï†ÄÏû•</button>
                <a href="/quote-parts" class="btn btn-secondary">Ï∑®ÏÜå</a>
                <button class="btn btn-outline-secondary" id="fullscreenBtn" onclick="toggleFullscreen()" title="Ï†ÑÏ≤¥ÌôîÎ©¥">‚õ∂ Ï†ÑÏ≤¥ÌôîÎ©¥</button>
                <div class="ms-auto">
                    <small class="text-muted">üí° Tip: CCSÍ≤¨Ï†ÅÎ≤àÌò∏Î°ú Ïó∞Í≤∞Ìï©ÎãàÎã§</small>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div class="excel-table">
                <table class="table table-bordered" id="dataTable">
                    <thead>
                        <tr>
                            <th class="row-number">#</th>
                            <th class="col-medium">CCSÍ≤¨Ï†ÅÎ≤àÌò∏</th>
                            <th class="col-medium">Í≥µÏû•Î™Ö</th>
                            <th class="col-medium">Ï†úÌíàÎ™Ö</th>
                            <th class="col-medium">Ï†úÌíàÏä§Ìéô</th>
                            <th class="col-medium">ÌíàÎ≤à</th>
                            <th class="col-medium">NewPartsNo</th>
                            <th class="col-medium">Model</th>
                            <th class="col-medium">MachineName</th>
                            <th class="col-medium">Type</th>
                            <th class="col-medium">UnitName</th>
                            <th class="col-long">Description</th>
                            <th class="col-medium">Maker</th>
                            <th class="col-medium">MurataPartsNo</th>
                            <th class="col-medium">Part(ÏàòÎüâ)</th>
                            <th class="col-medium">Í≤¨Ï†ÅÏàòÎüâ</th>
                            <th class="col-medium">Unitprice(BRT)</th>
                            <th class="col-medium">Unitprice(HMX)</th>
                            <th class="col-long">ÎπÑÍ≥†</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let rowCount = 0;

        window.onload = function() {
            for (let i = 0; i < 10; i++) {
                addRow();
            }
        };

        function addRow() {
            rowCount++;
            const tbody = document.getElementById('tableBody');
            const row = tbody.insertRow();

            row.innerHTML = `
                <td class="row-number">${rowCount}</td>
                <td><input type="text" class="form-control" name="ccsQuoteNo"></td>
                <td><input type="text" class="form-control" name="factoryName"></td>
                <td><input type="text" class="form-control" name="productName"></td>
                <td><input type="text" class="form-control" name="productSpec"></td>
                <td><input type="text" class="form-control" name="partNo"></td>
                <td><input type="text" class="form-control" name="newPartsNo"></td>
                <td><input type="text" class="form-control" name="model"></td>
                <td><input type="text" class="form-control" name="machineName"></td>
                <td><input type="text" class="form-control" name="type"></td>
                <td><input type="text" class="form-control" name="unitName"></td>
                <td><input type="text" class="form-control" name="description"></td>
                <td><input type="text" class="form-control" name="maker"></td>
                <td><input type="text" class="form-control" name="murataPartsNo"></td>
                <td><input type="text" class="form-control" name="partQuantity"></td>
                <td><input type="text" class="form-control" name="quoteQuantity"></td>
                <td><input type="text" class="form-control" name="unitPriceBrt"></td>
                <td><input type="text" class="form-control" name="unitPriceHmx"></td>
                <td><input type="text" class="form-control" name="remark"></td>
            `;
        }

        function removeLastRow() {
            const tbody = document.getElementById('tableBody');
            if (tbody.rows.length > 0) {
                tbody.deleteRow(tbody.rows.length - 1);
                rowCount--;
            }
        }

        function toNumber(value) {
            if (!value) return null;
            const cleaned = value.replace(/,/g, '').trim();
            return cleaned === '' ? null : Number(cleaned);
        }

        function toInteger(value) {
            if (!value) return null;
            const cleaned = value.replace(/,/g, '').trim();
            return cleaned === '' ? null : parseInt(cleaned, 10);
        }

        function saveAll() {
            const rows = document.getElementById('tableBody').rows;
            const quoteParts = [];

            for (let i = 0; i < rows.length; i++) {
                const inputs = rows[i].getElementsByTagName('input');

                let isEmpty = true;
                for (let j = 0; j < inputs.length; j++) {
                    if (inputs[j].value.trim() !== '') {
                        isEmpty = false;
                        break;
                    }
                }
                if (isEmpty) continue;

                const item = {
                    ccsQuoteNo: inputs[0].value,
                    factoryName: inputs[1].value,
                    productName: inputs[2].value,
                    productSpec: inputs[3].value,
                    partNo: inputs[4].value,
                    newPartsNo: inputs[5].value,
                    model: inputs[6].value,
                    machineName: inputs[7].value,
                    type: inputs[8].value,
                    unitName: inputs[9].value,
                    description: inputs[10].value,
                    maker: inputs[11].value,
                    murataPartsNo: inputs[12].value,
                    partQuantity: toInteger(inputs[13].value),
                    quoteQuantity: toInteger(inputs[14].value),
                    unitPriceBrt: toNumber(inputs[15].value),
                    unitPriceHmx: toNumber(inputs[16].value),
                    remark: inputs[17].value
                };

                quoteParts.push(item);
            }

            if (quoteParts.length === 0) {
                alert('Ï†ÄÏû•Ìï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }

            fetch('/quote-parts/bulk', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(quoteParts)
            })
            .then(response => {
                if (response.ok) {
                    alert(quoteParts.length + 'Í±¥ ÏöîÏ≤≠ÎêòÏóàÏäµÎãàÎã§.');
                    window.location.href = '/quote-parts';
                } else {
                    alert('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            });
        }

        document.addEventListener('paste', function(e) {
            const target = e.target;
            if (target.tagName !== 'INPUT') return;

            const pastedData = e.clipboardData.getData('text');
            if (!pastedData.includes('\t') && !pastedData.includes('\n')) return;

            e.preventDefault();

            const rows = pastedData.split('\n');
            const currentRow = target.closest('tr');
            const currentCell = target.closest('td');
            const startRowIndex = currentRow.rowIndex - 1;
            const startCellIndex = Array.from(currentRow.cells).indexOf(currentCell) - 1;

            const tbody = document.getElementById('tableBody');

            const neededRows = startRowIndex + rows.length;
            while (tbody.rows.length < neededRows) {
                addRow();
            }

            rows.forEach((row, rowOffset) => {
                const cells = row.split('\t');
                const targetRow = tbody.rows[startRowIndex + rowOffset];

                if (targetRow) {
                    const inputs = targetRow.getElementsByTagName('input');
                    cells.forEach((cellValue, cellOffset) => {
                        const targetInput = inputs[startCellIndex + cellOffset];
                        if (targetInput) {
                            targetInput.value = cellValue.trim();
                        }
                    });
                }
            });
        });

        document.addEventListener('keydown', function(e) {
            if (e.target.tagName !== 'INPUT') return;

            if (e.key === 'Tab') {
                e.preventDefault();
                const currentInput = e.target;
                const allInputs = Array.from(document.querySelectorAll('#tableBody input'));
                const currentIndex = allInputs.indexOf(currentInput);

                if (e.shiftKey) {
                    if (currentIndex > 0) {
                        allInputs[currentIndex - 1].focus();
                    }
                } else {
                    if (currentIndex < allInputs.length - 1) {
                        allInputs[currentIndex + 1].focus();
                    } else {
                        addRow();
                        setTimeout(() => {
                            const newInputs = document.querySelectorAll('#tableBody input');
                            newInputs[currentIndex + 1].focus();
                        }, 50);
                    }
                }
            }
        });

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        document.addEventListener('fullscreenchange', function() {
            const btn = document.getElementById('fullscreenBtn');
            if (document.fullscreenElement) {
                btn.textContent = '‚úï Ï†ÑÏ≤¥ÌôîÎ©¥ Ï¢ÖÎ£å';
            } else {
                btn.textContent = '‚õ∂ Ï†ÑÏ≤¥ÌôîÎ©¥';
            }
        });
    </script>
</body>
</html>
