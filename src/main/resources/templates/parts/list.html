<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parts Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-size: 0.75rem;
        }
        .table-responsive {
            overflow-x: auto;
        }
        .table {
            width: 100%;
            table-layout: fixed;
        }
        .table th {
            background-color: #2c3e50;
            color: white;
            font-weight: bold;
            padding: 4px 2px;
            font-size: 0.65rem;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.2;
        }
        .table td {
            font-size: 0.7rem;
            padding: 4px 2px;
            word-wrap: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* ì»¬ëŸ¼ë³„ ë„ˆë¹„ ì„¤ì • */
        .col-id { width: 2%; }
        .col-short { width: 4.5%; }
        .col-medium { width: 6%; }
        .col-long { width: 7.5%; }
        .col-desc { width: 11%; }
        .highlight {
            background-color: #ffff00;
            font-weight: bold;
            padding: 2px;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <h1 class="mb-4">ë¶€í’ˆ íŒŒì¸  ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
        
        <div class="mb-3 d-flex gap-2 align-items-center">
            <a href="/parts/bulk" class="btn btn-primary">ğŸ“Š ëŒ€ëŸ‰ ë“±ë¡ (ì—‘ì…€ í˜•ì‹)</a>
            <button onclick="exportFilteredToExcel()" class="btn btn-success">ğŸ“¥ Excel ë‹¤ìš´ë¡œë“œ</button>
            <div class="ms-auto d-flex align-items-center gap-2">
                <div id="exchangeBox" style="min-width:180px; text-align:right; font-weight:600; color:#2c3e50;">í™˜ìœ¨ ë¡œë”©...</div>
                <div style="width: 300px;">
                    <input type="text" id="searchInput" class="form-control" placeholder="ğŸ” ì „ì²´ ê²€ìƒ‰..." onkeyup="searchTable()">
                </div>
            </div>
        </div>
        
        <div th:if="${parts.isEmpty()}" class="alert alert-info">
            ë“±ë¡ëœ ë¶€í’ˆì´ ì—†ìŠµë‹ˆë‹¤. "ìƒˆ ë¶€í’ˆ ì¶”ê°€"ë¥¼ í´ë¦­í•˜ì—¬ ì¶”ê°€í•˜ì„¸ìš”.
        </div>
        
        <div th:if="${!parts.isEmpty()}" class="table-responsive">
            <table class="table table-striped table-bordered table-hover">
                <thead>
                    <tr>
                        <th class="col-id">ID</th>
                        <th class="col-medium">P-WBS</th>
                        <th class="col-medium">Project Code</th>
                        <th class="col-short">Ser.No.</th>
                        <th class="col-medium">Model</th>
                        <th class="col-long">Machine Name</th>
                        <th class="col-short">Type</th>
                        <th class="col-short">No.Machine</th>
                        <th class="col-medium">Unit Name</th>
                        <th class="col-long">Murata Parts No.</th>
                        <th class="col-long">New Parts No.</th>
                        <th class="col-desc">Description</th>
                        <th class="col-medium">Manufacturer</th>
                        <th class="col-long">Manut.Parts No.</th>
                        <th class="col-short">Rank</th>
                        <th class="col-short">Parts(M)</th>
                        <th class="col-short">Parts(T)</th>
                        <th class="col-medium">Unit price</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="part : ${parts}">
                        <td th:text="${part.id}"></td>
                        <td th:text="${part.pWbs}"></td>
                        <td th:text="${part.projectCode}"></td>
                        <td th:text="${part.serNo}"></td>
                        <td th:text="${part.model}"></td>
                        <td th:text="${part.machineName}"></td>
                        <td th:text="${part.type}"></td>
                        <td th:text="${part.noOfMachine}"></td>
                        <td th:text="${part.unitName}"></td>
                        <td th:text="${part.murataPartsNo}"></td>
                        <td th:text="${part.newPartsNo}"></td>
                        <td th:text="${part.descriptionOfParts}"></td>
                        <td th:text="${part.manufacturer}"></td>
                        <td th:text="${part.manutPartsNo}"></td>
                        <td th:text="${part.rank}"></td>
                        <td th:text="${part.noOfPartsMachine}"></td>
                        <td th:text="${part.noOfPartsTotal}"></td>
                        <td th:text="${part.unitPrice}"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Fetch exchange info and display in exchangeBox
        async function loadExchange() {
            const box = document.getElementById('exchangeBox');
            if (!box) return;
            try {
                const res = await fetch('/exchange');
                if (!res.ok) throw new Error('Network response was not ok');
                const text = await res.text();
                box.textContent = text;
            } catch (e) {
                console.error('í™˜ìœ¨ ì¡°íšŒ ì‹¤íŒ¨', e);
                box.textContent = 'í™˜ìœ¨ ì¡°íšŒ ì‹¤íŒ¨';
            }
        }

        // load on page ready
        document.addEventListener('DOMContentLoaded', () => {
            loadExchange();
        });

        // ì›ë³¸ í…ìŠ¤íŠ¸ë¥¼ ì €ì¥í•  ë§µ
        const originalCellTexts = new Map();
        
        function searchTable() {
            const input = document.getElementById('searchInput');
            if (!input) {
                console.error('ê²€ìƒ‰ ì…ë ¥ì°½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const filter = input.value.toLowerCase().trim();
            const table = document.querySelector('.table');
            
            if (!table) {
                console.log('í…Œì´ë¸”ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë°ì´í„°ê°€ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤)');
                return;
            }
            
            const tbody = table.querySelector('tbody');
            if (!tbody) {
                console.error('tbodyë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const rows = tbody.getElementsByTagName('tr');
            let visibleCount = 0;
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                
                // noResultRowëŠ” ê±´ë„ˆë›°ê¸°
                if (row.id === 'noResultRow') {
                    continue;
                }
                
                const cells = row.getElementsByTagName('td');
                let found = false;
                
                // ëª¨ë“  ì…€ì˜ í…ìŠ¤íŠ¸ë¥¼ ê²€ìƒ‰í•˜ê³  í•˜ì´ë¼ì´íŠ¸
                for (let j = 0; j < cells.length; j++) {
                    const cell = cells[j];
                    const cellKey = `${i}-${j}`;
                    
                    // ì›ë³¸ í…ìŠ¤íŠ¸ ì €ì¥ (ì²˜ìŒ í•œë²ˆë§Œ)
                    if (!originalCellTexts.has(cellKey)) {
                        originalCellTexts.set(cellKey, cell.innerHTML);
                    }
                    
                    // ì›ë³¸ í…ìŠ¤íŠ¸ë¡œ ë³µì›
                    cell.innerHTML = originalCellTexts.get(cellKey);
                    
                    const cellText = cell.textContent || cell.innerText;
                    
                    if (filter !== '' && cellText.toLowerCase().indexOf(filter) > -1) {
                        found = true;
                        
                        // í•˜ì´ë¼ì´íŠ¸ ì ìš©
                        const regex = new RegExp(`(${escapeRegex(filter)})`, 'gi');
                        const highlightedText = cell.innerHTML.replace(regex, '<span class="highlight">$1</span>');
                        cell.innerHTML = highlightedText;
                    }
                }
                
                if (found || filter === '') {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            }
            
            // ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì„ ë•Œ ë©”ì‹œì§€ í‘œì‹œ
            let noResultRow = document.getElementById('noResultRow');
            if (visibleCount === 0 && filter !== '') {
                if (!noResultRow) {
                    noResultRow = document.createElement('tr');
                    noResultRow.id = 'noResultRow';
                    const cell = document.createElement('td');
                    cell.colSpan = 18;
                    cell.className = 'text-center text-muted';
                    cell.style.padding = '20px';
                    cell.innerHTML = 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
                    noResultRow.appendChild(cell);
                    tbody.appendChild(noResultRow);
                }
                noResultRow.style.display = '';
            } else if (noResultRow) {
                noResultRow.style.display = 'none';
            }
            
            console.log('ê²€ìƒ‰ì–´:', filter, '/ ë³´ì´ëŠ” í–‰:', visibleCount);
        }
        
        // ì •ê·œì‹ íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„
        function escapeRegex(text) {
            return text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // í•„í„°ë§ëœ ë°ì´í„°ë§Œ Excelë¡œ ë‹¤ìš´ë¡œë“œ
        function exportFilteredToExcel() {
            const table = document.querySelector('.table');
            if (!table) {
                alert('í…Œì´ë¸”ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const tbody = table.querySelector('tbody');
            if (!tbody) {
                alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const rows = tbody.getElementsByTagName('tr');
            const filteredIds = [];
            
            // í˜„ì¬ ë³´ì´ëŠ” í–‰ì˜ IDë§Œ ìˆ˜ì§‘
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                if (row.id === 'noResultRow') continue;
                
                // displayê°€ noneì´ ì•„ë‹Œ ê²½ìš°ë§Œ (ë³´ì´ëŠ” í–‰)
                if (row.style.display !== 'none') {
                    const idCell = row.getElementsByTagName('td')[0];
                    if (idCell) {
                        const id = idCell.textContent.trim();
                        if (id) {
                            filteredIds.push(id);
                        }
                    }
                }
            }
            
            if (filteredIds.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // POST ìš”ì²­ìœ¼ë¡œ í•„í„°ë§ëœ ID ì „ì†¡
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/parts/export/excel';
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'ids';
            input.value = filteredIds.join(',');
            
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        }
    </script>
</body>
</html>
