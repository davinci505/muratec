<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶€í’ˆ ëŒ€ëŸ‰ ë“±ë¡</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-size: 0.75rem;
        }
        .excel-table {
            width: 100%;
            overflow-x: auto;
        }
        .excel-table table {
            width: 100%;
            table-layout: fixed;
        }
        .excel-table input,
        .excel-table textarea {
            width: 100%;
            font-size: 0.7rem;
            padding: 2px 4px;
            border: 1px solid #ccc;
        }
        .excel-table th {
            background-color: #2c3e50;
            color: white;
            font-weight: bold;
            padding: 4px 2px;
            font-size: 0.65rem;
            white-space: normal;
            word-wrap: break-word;
            position: sticky;
            top: 0;
            z-index: 10;
            line-height: 1.2;
        }
        .excel-table td {
            padding: 1px;
            border: 1px solid #ddd;
        }
        .row-number {
            background-color: #ecf0f1;
            font-weight: bold;
            text-align: center;
            width: 25px;
            max-width: 25px;
            padding: 2px !important;
        }
        .btn-container {
            position: sticky;
            top: 0;
            background: white;
            z-index: 100;
            padding: 10px 0;
            margin-bottom: 10px;
            border-bottom: 2px solid #ddd;
        }
        .table-container {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        /* ì»¬ëŸ¼ë³„ ë„ˆë¹„ ì„¤ì • */
        .col-short { width: 4%; }
        .col-medium { width: 5.5%; }
        .col-long { width: 7%; }
        .col-desc { width: 10%; }
    </style>
</head>
<body>
    <div class="container-fluid mt-3">
        <div class="btn-container">
            <h2>ë¶€í’ˆ ëŒ€ëŸ‰ ë“±ë¡ (ì—‘ì…€ í˜•ì‹)</h2>
            <div class="d-flex gap-2 mt-2">
                <button class="btn btn-success" onclick="addRow()">+ í–‰ ì¶”ê°€</button>
                <button class="btn btn-danger" onclick="removeLastRow()">- ë§ˆì§€ë§‰ í–‰ ì‚­ì œ</button>
                <button class="btn btn-primary" onclick="saveAll()">ì „ì²´ ì €ì¥</button>
                <a href="/parts" class="btn btn-secondary">ì·¨ì†Œ</a>
                <div class="ms-auto">
                    <small class="text-muted">ğŸ’¡ Tip: ì—‘ì…€ì—ì„œ ë³µì‚¬í•œ ë°ì´í„°ë¥¼ ì²« ë²ˆì§¸ ì…€ì— ë¶™ì—¬ë„£ìœ¼ë©´ ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤</small>
                </div>
            </div>
        </div>
        
        <div class="table-container">
            <div class="excel-table">
                <table class="table table-bordered" id="dataTable">
                    <thead>
                        <tr>
                            <th class="row-number">#</th>
                            <th class="col-medium">P-WBS</th>
                            <th class="col-medium">Project Code</th>
                            <th class="col-short">Ser.No.</th>
                            <th class="col-medium">Model</th>
                            <th class="col-long">Machine Name</th>
                            <th class="col-short">Type</th>
                            <th class="col-short">No.Machine</th>
                            <th class="col-medium">Unit Name</th>
                            <th class="col-long">Murata Parts No.</th>
                            <th class="col-long">New Parts No.</th>
                            <th class="col-desc">Description</th>
                            <th class="col-medium">Manufacturer</th>
                            <th class="col-long">Manut.Parts No.</th>
                            <th class="col-short">Rank</th>
                            <th class="col-short">Parts(M)</th>
                            <th class="col-short">Parts(T)</th>
                            <th class="col-medium">Unit price</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- ì´ˆê¸° 5í–‰ ìƒì„± -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let rowCount = 0;
        
        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸° 10í–‰ ìƒì„±
        window.onload = function() {
            for(let i = 0; i < 10; i++) {
                addRow();
            }
        };
        
        function addRow() {
            rowCount++;
            const tbody = document.getElementById('tableBody');
            const row = tbody.insertRow();
            
            row.innerHTML = `
                <td class="row-number">${rowCount}</td>
                <td><input type="text" class="form-control" name="pWbs"></td>
                <td><input type="text" class="form-control" name="projectCode"></td>
                <td><input type="text" class="form-control" name="serNo"></td>
                <td><input type="text" class="form-control" name="model"></td>
                <td><input type="text" class="form-control" name="machineName"></td>
                <td><input type="text" class="form-control" name="type"></td>
                <td><input type="number" class="form-control" name="noOfMachine"></td>
                <td><input type="text" class="form-control" name="unitName"></td>
                <td><input type="text" class="form-control" name="murataPartsNo"></td>
                <td><input type="text" class="form-control" name="newPartsNo"></td>
                <td><input type="text" class="form-control" name="descriptionOfParts"></td>
                <td><input type="text" class="form-control" name="manufacturer"></td>
                <td><input type="text" class="form-control" name="manutPartsNo"></td>
                <td><input type="text" class="form-control" name="rank"></td>
                <td><input type="text" class="form-control" name="noOfPartsMachine"></td>
                <td><input type="text" class="form-control" name="noOfPartsTotal"></td>
                <td><input type="text" class="form-control" name="unitPrice"></td>
            `;
        }
        
        function removeLastRow() {
            const tbody = document.getElementById('tableBody');
            if(tbody.rows.length > 0) {
                tbody.deleteRow(tbody.rows.length - 1);
                rowCount--;
            }
        }
        
        function saveAll() {
            const rows = document.getElementById('tableBody').rows;
            const parts = [];
            
            for(let i = 0; i < rows.length; i++) {
                const inputs = rows[i].getElementsByTagName('input');
                
                // ë¹ˆ í–‰ ì²´í¬ (ëª¨ë“  í•„ë“œê°€ ë¹„ì–´ìˆìœ¼ë©´ ìŠ¤í‚µ)
                let isEmpty = true;
                for(let j = 0; j < inputs.length; j++) {
                    if(inputs[j].value.trim() !== '') {
                        isEmpty = false;
                        break;
                    }
                }
                
                if(isEmpty) continue;
                
                // ì½¤ë§ˆ ì œê±° í•¨ìˆ˜
                const removeCommas = (value) => value ? value.replace(/,/g, '') : '';
                
                const part = {
                    pWbs: inputs[0].value,
                    projectCode: inputs[1].value,
                    serNo: inputs[2].value,
                    model: inputs[3].value,
                    machineName: inputs[4].value,
                    type: inputs[5].value,
                    noOfMachine: removeCommas(inputs[6].value) ? parseInt(removeCommas(inputs[6].value)) : null,
                    unitName: inputs[7].value,
                    murataPartsNo: inputs[8].value,
                    newPartsNo: inputs[9].value,
                    descriptionOfParts: inputs[10].value,
                    manufacturer: inputs[11].value,
                    manutPartsNo: inputs[12].value,
                    rank: inputs[13].value,
                    noOfPartsMachine: removeCommas(inputs[14].value) ? parseInt(removeCommas(inputs[14].value)) : null,
                    noOfPartsTotal: removeCommas(inputs[15].value) ? parseInt(removeCommas(inputs[15].value)) : null,
                    unitPrice: inputs[16].value || null
                };
                
                parts.push(part);
            }
            
            if(parts.length === 0) {
                alert('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            console.log('ì €ì¥í•  ë°ì´í„°:', parts);
            
            fetch('/parts/bulk', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(parts)
            })
            .then(response => {
                if(response.ok) {
                    alert(parts.length + 'ê°œì˜ ë¶€í’ˆì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    window.location.href = '/parts';
                } else {
                    alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }
        
        // ì—‘ì…€ ë³µì‚¬-ë¶™ì—¬ë„£ê¸° ì§€ì›
        document.addEventListener('paste', function(e) {
            const target = e.target;
            if(target.tagName !== 'INPUT') return;
            
            const pastedData = e.clipboardData.getData('text');
            if(!pastedData.includes('\t') && !pastedData.includes('\n')) return;
            
            e.preventDefault();
            
            const rows = pastedData.split('\n');
            const currentRow = target.closest('tr');
            const currentCell = target.closest('td');
            const startRowIndex = currentRow.rowIndex - 1;
            const startCellIndex = Array.from(currentRow.cells).indexOf(currentCell) - 1;
            
            const tbody = document.getElementById('tableBody');
            
            // í•„ìš”í•œ ë§Œí¼ í–‰ ì¶”ê°€
            const neededRows = startRowIndex + rows.length;
            while(tbody.rows.length < neededRows) {
                addRow();
            }
            
            rows.forEach((row, rowOffset) => {
                const cells = row.split('\t');
                const targetRow = tbody.rows[startRowIndex + rowOffset];
                
                if(targetRow) {
                    const inputs = targetRow.getElementsByTagName('input');
                    cells.forEach((cellValue, cellOffset) => {
                        const targetInput = inputs[startCellIndex + cellOffset];
                        if(targetInput) {
                            targetInput.value = cellValue.trim();
                        }
                    });
                }
            });
        });
        
        // Tab í‚¤ë¡œ ì…€ ì´ë™
        document.addEventListener('keydown', function(e) {
            if(e.target.tagName !== 'INPUT') return;
            
            if(e.key === 'Tab') {
                e.preventDefault();
                const currentInput = e.target;
                const currentCell = currentInput.closest('td');
                const currentRow = currentInput.closest('tr');
                const allInputs = Array.from(document.querySelectorAll('#tableBody input'));
                const currentIndex = allInputs.indexOf(currentInput);
                
                if(e.shiftKey) {
                    // Shift+Tab: ì´ì „ ì…€
                    if(currentIndex > 0) {
                        allInputs[currentIndex - 1].focus();
                    }
                } else {
                    // Tab: ë‹¤ìŒ ì…€
                    if(currentIndex < allInputs.length - 1) {
                        allInputs[currentIndex + 1].focus();
                    } else {
                        // ë§ˆì§€ë§‰ ì…€ì´ë©´ ìƒˆ í–‰ ì¶”ê°€
                        addRow();
                        setTimeout(() => {
                            const newInputs = document.querySelectorAll('#tableBody input');
                            newInputs[currentIndex + 1].focus();
                        }, 50);
                    }
                }
            }
        });
    </script>
</body>
</html>
