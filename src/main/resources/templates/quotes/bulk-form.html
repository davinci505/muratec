<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(~{::title}, ~{::.content}, ~{::style}, ~{::script})}"
      th:with="activePage='quotes'">
<head>
    <title>Í≤¨Ï†Å ÎåÄÎüâ Îì±Î°ù - MURATEC</title>
    <style>
        .excel-table {
            width: 100%;
            overflow-x: auto;
        }
        .excel-table table {
            width: 100%;
            table-layout: fixed;
        }
        .excel-table input,
        .excel-table select {
            width: 100%;
            font-size: 0.7rem;
            padding: 2px 4px;
            border: 1px solid #ccc;
        }
        .excel-table th {
            background-color: #2c3e50;
            color: white;
            font-weight: bold;
            padding: 4px 2px;
            font-size: 0.65rem;
            white-space: normal;
            word-wrap: break-word;
            position: sticky;
            top: 0;
            z-index: 10;
            line-height: 1.2;
        }
        .excel-table td {
            padding: 1px;
            border: 1px solid #ddd;
        }
        .row-number {
            background-color: #ecf0f1;
            font-weight: bold;
            text-align: center;
            width: 30px;
            max-width: 30px;
            padding: 2px !important;
        }
        .btn-container {
            position: sticky;
            top: 0;
            background: white;
            z-index: 100;
            padding: 10px 0;
            margin-bottom: 10px;
            border-bottom: 2px solid #ddd;
        }
        .table-container {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        .row-number { width: 3% !important; }
        .col-short { width: 6%; }
        .col-medium { width: 7.5%; }
        .col-long { width: 9%; }
    </style>
</head>
<body>
    <div class="content">
        <div class="btn-container">
            <h2>CCS Í≤¨Ï†Å ÎåÄÎüâ Îì±Î°ù</h2>
            <div class="d-flex gap-2 mt-2">
                <button class="btn btn-success" onclick="addRow()">+ Ìñâ Ï∂îÍ∞Ä</button>
                <button class="btn btn-danger" onclick="removeLastRow()">- ÎßàÏßÄÎßâ Ìñâ ÏÇ≠Ï†ú</button>
                <button class="btn btn-primary" onclick="saveAll()">Ï†ÑÏ≤¥ Ï†ÄÏû•</button>
                <a href="/quotes" class="btn btn-secondary">Ï∑®ÏÜå</a>
                <button class="btn btn-outline-secondary" id="fullscreenBtn" onclick="toggleFullscreen()" title="Ï†ÑÏ≤¥ÌôîÎ©¥">‚õ∂ Ï†ÑÏ≤¥ÌôîÎ©¥</button>
                <div class="ms-auto">
                    <small class="text-muted">üí° Tip: jobNo Í∏∞Ï§ÄÏúºÎ°ú ÏùòÎ¢∞Î•º Ïó∞Í≤∞Ìï©ÎãàÎã§</small>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div class="excel-table">
                <table class="table table-bordered" id="dataTable">
                    <thead>
                        <tr>
                            <th class="row-number">#</th>
                            <th class="col-medium">ÏûëÎ≤à</th>
                            <th class="col-medium">CCSÍ≤¨Ï†ÅÎÇ†Ïßú</th>
                            <th class="col-medium">CCSÍ≤¨Ï†ÅÎ≤àÌò∏</th>
                            <th class="col-medium">CCSÍ∏àÏï°(BRT)</th>
                            <th class="col-medium">CCSÍ∏àÏï°(HMX)</th>
                            <th class="col-long">ÎÇ¥Ïó≠</th>
                            <th class="col-medium">BRTÍ≤¨Ï†ÅÎ≤àÌò∏</th>
                            <th class="col-medium">BRTÍ≤¨Ï†ÅÎÇ†Ïßú</th>
                            <th class="col-medium">BRTÎÑ§Í≥†Í∏àÏï°</th>
                            <th class="col-short">ÏÉÅÌÉú</th>
                            <th class="col-medium">ÏÉÅÌÉúÎÇ†Ïßú</th>
                            <th class="col-medium">HMXÎ∞úÏ£ºÎ≤àÌò∏</th>
                            <th class="col-medium">HMXÎ∞úÏ£ºÎÇ†Ïßú</th>
                            <th class="col-medium">CCSPOÎ≤àÌò∏</th>
                            <th class="col-medium">CCSPOÎÇ†Ïßú</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const statusOptions = /*[[${statusOptions}]]*/ [];
        let rowCount = 0;

        window.onload = function() {
            for (let i = 0; i < 10; i++) {
                addRow();
            }
        };

        function getTodayString() {
            const now = new Date();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${now.getFullYear()}-${month}-${day}`;
        }

        function addRow() {
            rowCount++;
            const tbody = document.getElementById('tableBody');
            const row = tbody.insertRow();

            const statusOptionsHtml = ['<option value="">ÏÑ†ÌÉù</option>']
                .concat(statusOptions.map(s => `<option value="${s}">${s}</option>`))
                .join('');

            row.innerHTML = `
                <td class="row-number">${rowCount}</td>
                <td><input type="text" class="form-control" name="jobNo"></td>
                <td><input type="text" class="form-control" name="ccsQuoteDate" placeholder="YYYYMMDD" maxlength="10" pattern="\\d{4}-\\d{2}-\\d{2}" inputmode="numeric" value="${getTodayString()}"></td>
                <td><input type="text" class="form-control" name="ccsQuoteNo"></td>
                <td><input type="text" class="form-control" name="ccsAmountBrt"></td>
                <td><input type="text" class="form-control" name="ccsAmountHmx"></td>
                <td><input type="text" class="form-control" name="description"></td>
                <td><input type="text" class="form-control" name="brtQuoteNo"></td>
                <td><input type="text" class="form-control" name="brtQuoteDate" placeholder="YYYYMMDD" maxlength="10" pattern="\\d{4}-\\d{2}-\\d{2}" inputmode="numeric"></td>
                <td><input type="text" class="form-control" name="brtNegotiatedAmount"></td>
                <td><select class="form-select" name="status">${statusOptionsHtml}</select></td>
                <td><input type="text" class="form-control" name="statusDate" placeholder="YYYYMMDD" maxlength="10" pattern="\\d{4}-\\d{2}-\\d{2}" inputmode="numeric"></td>
                <td><input type="text" class="form-control" name="hmxOrderNo"></td>
                <td><input type="text" class="form-control" name="hmxOrderDate" placeholder="YYYYMMDD" maxlength="10" pattern="\\d{4}-\\d{2}-\\d{2}" inputmode="numeric"></td>
                <td><input type="text" class="form-control" name="ccsPoNo"></td>
                <td><input type="text" class="form-control" name="ccsPoDate" placeholder="YYYYMMDD" maxlength="10" pattern="\\d{4}-\\d{2}-\\d{2}" inputmode="numeric"></td>
            `;
        }

        function removeLastRow() {
            const tbody = document.getElementById('tableBody');
            if (tbody.rows.length > 0) {
                tbody.deleteRow(tbody.rows.length - 1);
                rowCount--;
            }
        }

        function toNumber(value) {
            if (!value) return null;
            const cleaned = value.replace(/,/g, '').trim();
            return cleaned === '' ? null : Number(cleaned);
        }

        const dateFieldNames = new Set([
            'ccsQuoteDate',
            'brtQuoteDate',
            'statusDate',
            'hmxOrderDate',
            'ccsPoDate'
        ]);
        const datePattern = /^\d{4}-\d{2}-\d{2}$/;

        function stripToDigits(value) {
            return (value || '').replace(/\D/g, '').slice(0, 8);
        }

        function formatDateValue(value) {
            const raw = stripToDigits(value);
            if (raw.length === 8) {
                return raw.slice(0, 4) + '-' + raw.slice(4, 6) + '-' + raw.slice(6);
            }
            return raw;
        }

        function validateDateValue(value) {
            if (!value) return true;
            if (!datePattern.test(value)) return false;
            const parts = value.split('-').map(Number);
            const year = parts[0];
            const month = parts[1];
            const day = parts[2];
            const date = new Date(year, month - 1, day);
            return date.getFullYear() === year && date.getMonth() === month - 1 && date.getDate() === day;
        }

        function saveAll() {
            const rows = document.getElementById('tableBody').rows;
            const quotes = [];
            let firstInvalidInput = null;

            for (let i = 0; i < rows.length; i++) {
                const inputs = rows[i].querySelectorAll('input, select');

                let isEmpty = true;
                for (let j = 0; j < inputs.length; j++) {
                    if (inputs[j].value.trim() !== '') {
                        isEmpty = false;
                        break;
                    }
                }
                if (isEmpty) continue;

                const ccsQuoteDate = formatDateValue(inputs[1].value) || null;
                const brtQuoteDate = formatDateValue(inputs[7].value) || null;
                const statusDate = formatDateValue(inputs[10].value) || null;
                const hmxOrderDate = formatDateValue(inputs[12].value) || null;
                const ccsPoDate = formatDateValue(inputs[14].value) || null;

                const dateValues = [
                    { input: inputs[1], value: ccsQuoteDate },
                    { input: inputs[7], value: brtQuoteDate },
                    { input: inputs[10], value: statusDate },
                    { input: inputs[12], value: hmxOrderDate },
                    { input: inputs[14], value: ccsPoDate }
                ];

                dateValues.forEach(({ input, value }) => {
                    const isValid = validateDateValue(value || '');
                    input.classList.toggle('is-invalid', !isValid);
                    if (!isValid && !firstInvalidInput) {
                        firstInvalidInput = input;
                    }
                });

                const quote = {
                    jobNo: inputs[0].value,
                    ccsQuoteDate: ccsQuoteDate,
                    ccsQuoteNo: inputs[2].value,
                    ccsAmountBrt: toNumber(inputs[3].value),
                    ccsAmountHmx: toNumber(inputs[4].value),
                    description: inputs[5].value,
                    brtQuoteNo: inputs[6].value,
                    brtQuoteDate: brtQuoteDate,
                    brtNegotiatedAmount: toNumber(inputs[8].value),
                    status: inputs[9].value || null,
                    statusDate: statusDate,
                    hmxOrderNo: inputs[11].value,
                    hmxOrderDate: hmxOrderDate,
                    ccsPoNo: inputs[13].value,
                    ccsPoDate: ccsPoDate
                };

                quotes.push(quote);
            }

            if (firstInvalidInput) {
                alert('ÎÇ†Ïßú ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§. YYYY-MM-DD ÌòïÏãùÏúºÎ°ú ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                firstInvalidInput.focus();
                return;
            }

            if (quotes.length === 0) {
                alert('Ï†ÄÏû•Ìï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }

            fetch('/quotes/bulk', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(quotes)
            })
            .then(response => {
                if (response.ok) {
                    alert(quotes.length + 'Í±¥ ÏöîÏ≤≠ÎêòÏóàÏäµÎãàÎã§.');
                    window.location.href = '/quotes';
                } else {
                    alert('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            });
        }

        document.addEventListener('input', function(e) {
            const target = e.target;
            if (target.tagName !== 'INPUT') return;
            if (!dateFieldNames.has(target.name)) return;
            target.value = stripToDigits(target.value);
            target.classList.remove('is-invalid');
        });

        document.addEventListener('blur', function(e) {
            const target = e.target;
            if (target.tagName !== 'INPUT') return;
            if (!dateFieldNames.has(target.name)) return;
            target.value = formatDateValue(target.value);
            target.classList.toggle('is-invalid', !validateDateValue(target.value));
        }, true);

        document.addEventListener('paste', function(e) {
            const target = e.target;
            if (target.tagName !== 'INPUT') return;

            const pastedData = e.clipboardData.getData('text');
            if (!pastedData.includes('\t') && !pastedData.includes('\n')) return;

            e.preventDefault();

            const rows = pastedData.split('\n');
            const currentRow = target.closest('tr');
            const currentCell = target.closest('td');
            const startRowIndex = currentRow.rowIndex - 1;
            const startCellIndex = Array.from(currentRow.cells).indexOf(currentCell) - 1;

            const tbody = document.getElementById('tableBody');

            const neededRows = startRowIndex + rows.length;
            while (tbody.rows.length < neededRows) {
                addRow();
            }

            rows.forEach((row, rowOffset) => {
                const cells = row.split('\t');
                const targetRow = tbody.rows[startRowIndex + rowOffset];

                if (targetRow) {
                    const inputs = targetRow.querySelectorAll('input, select');
                    cells.forEach((cellValue, cellOffset) => {
                        const targetInput = inputs[startCellIndex + cellOffset];
                        if (targetInput && targetInput.tagName === 'INPUT') {
                            if (dateFieldNames.has(targetInput.name)) {
                                targetInput.value = formatDateValue(cellValue.trim());
                            } else {
                                targetInput.value = cellValue.trim();
                            }
                        }
                    });
                }
            });
        });

        document.addEventListener('keydown', function(e) {
            if (e.target.tagName !== 'INPUT') return;

            if (e.key === 'Tab') {
                e.preventDefault();
                const currentInput = e.target;
                const allInputs = Array.from(document.querySelectorAll('#tableBody input'));
                const currentIndex = allInputs.indexOf(currentInput);

                if (e.shiftKey) {
                    if (currentIndex > 0) {
                        allInputs[currentIndex - 1].focus();
                    }
                } else {
                    if (currentIndex < allInputs.length - 1) {
                        allInputs[currentIndex + 1].focus();
                    } else {
                        addRow();
                        setTimeout(() => {
                            const newInputs = document.querySelectorAll('#tableBody input');
                            newInputs[currentIndex + 1].focus();
                        }, 50);
                    }
                }
            }
        });

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        document.addEventListener('fullscreenchange', function() {
            const btn = document.getElementById('fullscreenBtn');
            if (document.fullscreenElement) {
                btn.textContent = '‚úï Ï†ÑÏ≤¥ÌôîÎ©¥ Ï¢ÖÎ£å';
            } else {
                btn.textContent = '‚õ∂ Ï†ÑÏ≤¥ÌôîÎ©¥';
            }
        });
    </script>
</body>
</html>
