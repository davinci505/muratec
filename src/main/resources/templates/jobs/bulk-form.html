<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(~{::title}, ~{::.content}, ~{::style}, ~{::script})}"
      th:with="activePage='jobs'">
<head>
    <title>ì˜ë¢° ëŒ€ëŸ‰ ë“±ë¡ - MURATEC</title>
    <style>
        .excel-table {
            width: 100%;
            overflow-x: auto;
        }
        .excel-table table {
            width: 100%;
            table-layout: fixed;
        }
        .excel-table input {
            width: 100%;
            font-size: 0.7rem;
            padding: 2px 4px;
            border: 1px solid #ccc;
        }
        .excel-table th {
            background-color: #2c3e50;
            color: white;
            font-weight: bold;
            padding: 4px 2px;
            font-size: 0.65rem;
            white-space: normal;
            word-wrap: break-word;
            position: sticky;
            top: 0;
            z-index: 10;
            line-height: 1.2;
        }
        .excel-table td {
            padding: 1px;
            border: 1px solid #ddd;
        }
        .row-number {
            background-color: #ecf0f1;
            font-weight: bold;
            text-align: center;
            width: 30px;
            max-width: 30px;
            padding: 2px !important;
        }
        .btn-container {
            position: sticky;
            top: 0;
            background: white;
            z-index: 100;
            padding: 10px 0;
            margin-bottom: 10px;
            border-bottom: 2px solid #ddd;
        }
        .table-container {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        .row-number { width: 3% !important; }
        .col-medium { width: 8%; }
        .col-long { width: 10%; }
    </style>
</head>
<body>
    <div class="content">
        <div class="btn-container">
            <h2>ì‘ë²ˆ ì˜ë¢° ëŒ€ëŸ‰ ë“±ë¡</h2>
            <div class="d-flex gap-2 mt-2">
                <button class="btn btn-success" onclick="addRow()">+ í–‰ ì¶”ê°€</button>
                <button class="btn btn-danger" onclick="removeLastRow()">- ë§ˆì§€ë§‰ í–‰ ì‚­ì œ</button>
                <button class="btn btn-primary" onclick="saveAll()">ì „ì²´ ì €ì¥</button>
                <a href="/jobs" class="btn btn-secondary">ì·¨ì†Œ</a>
                <button class="btn btn-outline-secondary" id="fullscreenBtn" onclick="toggleFullscreen()" title="ì „ì²´í™”ë©´">â›¶ ì „ì²´í™”ë©´</button>
                <div class="ms-auto">
                    <small class="text-muted">ğŸ’¡ Tip: ì—‘ì…€ì—ì„œ ë³µì‚¬í•œ ë°ì´í„°ë¥¼ ì²« ë²ˆì§¸ ì…€ì— ë¶™ì—¬ë„£ìœ¼ë©´ ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤</small>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div class="excel-table">
                <table class="table table-bordered" id="dataTable">
                    <thead>
                        <tr>
                            <th class="row-number">#</th>
                            <th class="col-medium">ì‘ë²ˆ</th>
                            <th class="col-medium">ì˜ë¢°ì¸</th>
                            <th class="col-medium">ì˜ë¢°ë‚ ì§œ</th>
                            <th class="col-medium">ê³ ê°ëª…</th>
                            <th class="col-medium">ê³µì¥ëª…</th>
                            <th class="col-medium">ì œí’ˆëª…</th>
                            <th class="col-long">ì œí’ˆìŠ¤í™</th>
                            <th class="col-medium">í’ˆë²ˆ</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let rowCount = 0;

        window.onload = function() {
            for (let i = 0; i < 10; i++) {
                addRow();
            }
        };

        function addRow() {
            rowCount++;
            const tbody = document.getElementById('tableBody');
            const row = tbody.insertRow();

            row.innerHTML = `
                <td class="row-number">${rowCount}</td>
                <td><input type="text" class="form-control" name="jobNo"></td>
                <td><input type="text" class="form-control" name="requester"></td>
                <td><input type="text" class="form-control" name="requestDate" placeholder="YYYYMMDD" maxlength="10" pattern="\d{4}-\d{2}-\d{2}" inputmode="numeric"></td>
                <td><input type="text" class="form-control" name="customerName"></td>
                <td><input type="text" class="form-control" name="factoryName"></td>
                <td><input type="text" class="form-control" name="productName"></td>
                <td><input type="text" class="form-control" name="productSpec"></td>
                <td><input type="text" class="form-control" name="partNo"></td>
            `;
        }

        function removeLastRow() {
            const tbody = document.getElementById('tableBody');
            if (tbody.rows.length > 0) {
                tbody.deleteRow(tbody.rows.length - 1);
                rowCount--;
            }
        }

        function formatDateValue(value) {
            const raw = (value || '').replace(/\D/g, '').slice(0, 8);
            if (raw.length !== 8) return raw;
            return raw.slice(0, 4) + '-' + raw.slice(4, 6) + '-' + raw.slice(6);
        }

        function saveAll() {
            const rows = document.getElementById('tableBody').rows;
            const jobs = [];

            for (let i = 0; i < rows.length; i++) {
                const inputs = rows[i].getElementsByTagName('input');

                let isEmpty = true;
                for (let j = 0; j < inputs.length; j++) {
                    if (inputs[j].value.trim() !== '') {
                        isEmpty = false;
                        break;
                    }
                }
                if (isEmpty) continue;

                const job = {
                    jobNo: inputs[0].value,
                    requester: inputs[1].value,
                    requestDate: formatDateValue(inputs[2].value) || null,
                    customerName: inputs[3].value,
                    factoryName: inputs[4].value,
                    productName: inputs[5].value,
                    productSpec: inputs[6].value,
                    partNo: inputs[7].value
                };

                jobs.push(job);
            }

            if (jobs.length === 0) {
                alert('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            fetch('/jobs/bulk', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(jobs)
            })
            .then(response => {
                if (response.ok) {
                    alert(jobs.length + 'ê±´ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    window.location.href = '/jobs';
                } else {
                    alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }

        document.addEventListener('paste', function(e) {
            const target = e.target;
            if (target.tagName !== 'INPUT') return;

            const pastedData = e.clipboardData.getData('text');
            if (!pastedData.includes('\t') && !pastedData.includes('\n')) return;

            e.preventDefault();

            const rows = pastedData.split('\n');
            const currentRow = target.closest('tr');
            const currentCell = target.closest('td');
            const startRowIndex = currentRow.rowIndex - 1;
            const startCellIndex = Array.from(currentRow.cells).indexOf(currentCell) - 1;

            const tbody = document.getElementById('tableBody');

            const neededRows = startRowIndex + rows.length;
            while (tbody.rows.length < neededRows) {
                addRow();
            }

            rows.forEach((row, rowOffset) => {
                const cells = row.split('\t');
                const targetRow = tbody.rows[startRowIndex + rowOffset];

                if (targetRow) {
                    const inputs = targetRow.getElementsByTagName('input');
                    cells.forEach((cellValue, cellOffset) => {
                        const targetInput = inputs[startCellIndex + cellOffset];
                        if (targetInput) {
                            targetInput.value = cellValue.trim();
                        }
                    });
                }
            });
        });

        document.addEventListener('keydown', function(e) {
            if (e.target.tagName !== 'INPUT') return;

            if (e.key === 'Tab') {
                e.preventDefault();
                const currentInput = e.target;
                const allInputs = Array.from(document.querySelectorAll('#tableBody input'));
                const currentIndex = allInputs.indexOf(currentInput);

                if (e.shiftKey) {
                    if (currentIndex > 0) {
                        allInputs[currentIndex - 1].focus();
                    }
                } else {
                    if (currentIndex < allInputs.length - 1) {
                        allInputs[currentIndex + 1].focus();
                    } else {
                        addRow();
                        setTimeout(() => {
                            const newInputs = document.querySelectorAll('#tableBody input');
                            newInputs[currentIndex + 1].focus();
                        }, 50);
                    }
                }
            }
        });

        document.addEventListener('input', function(e) {
            const target = e.target;
            if (target.tagName !== 'INPUT') return;
            if (target.name !== 'requestDate') return;
            target.value = target.value.replace(/\D/g, '').slice(0, 8);
        });

        document.addEventListener('blur', function(e) {
            const target = e.target;
            if (target.tagName !== 'INPUT') return;
            if (target.name !== 'requestDate') return;
            target.value = formatDateValue(target.value);
        }, true);

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        document.addEventListener('fullscreenchange', function() {
            const btn = document.getElementById('fullscreenBtn');
            if (document.fullscreenElement) {
                btn.textContent = 'âœ• ì „ì²´í™”ë©´ ì¢…ë£Œ';
            } else {
                btn.textContent = 'â›¶ ì „ì²´í™”ë©´';
            }
        });
    </script>
</body>
</html>
